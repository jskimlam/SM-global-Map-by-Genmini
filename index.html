<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global SM Plant Status (Made by LAM)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #0A2647; --accent: #1597bb; --bg-light: #F5F7F8; --text-dark: #333; --trouble: #222; }
        body { margin: 0; padding: 0; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        
        /* 메인 레이아웃 */
        #map-container { position: relative; height: 100vh; width: 100%; transition: margin-left 0.3s ease-in-out; }
        #map { height: 100%; width: 100%; background: #eef2f3; }

        /* 사이드바 디자인 */
        #sidebar {
            position: fixed; top: 0; left: -350px; /* 초기 숨김 상태 */
            width: 350px; height: 100%; background: white; z-index: 1000;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1); transition: left 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        #sidebar.active { left: 0; }

        /* 사이드바 헤더 및 요약 */
        .sidebar-header { background: var(--primary); color: white; padding: 20px; }
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .bi-summary { display: flex; justify-content: space-between; padding: 15px 20px; background: var(--accent); color: white; }
        .summary-item span { display: block; font-size: 0.8rem; opacity: 0.9; }
        .summary-item strong { font-size: 1.1rem; }

        /* 리스트 영역 */
        #list-container { flex-grow: 1; overflow-y: auto; padding: 10px; background: var(--bg-light); }
        .plant-item {
            background: white; padding: 12px 15px; margin-bottom: 10px; border-radius: 8px;
            border-left: 4px solid var(--accent); cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .plant-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .plant-item.trouble { border-left-color: var(--trouble); }
        .plant-name { font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .plant-detail { font-size: 0.85rem; color: #666; display: flex; justify-content: space-between; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }

        /* 토글 버튼 */
        #sidebar-toggle {
            position: absolute; top: 20px; left: 20px; z-index: 1100;
            background: var(--primary); color: white; border: none;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* 팝업 스타일 */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .popup-content h3 { margin: 0 0 8px 0; color: var(--primary); }
        .popup-content p { margin: 5px 0; font-size: 0.9rem; color: #555; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
             <h2>Global SM Plant Status <span style="font-weight:300; font-size:0.8rem;">| by LAM</span></h2>
        </div>
        <div class="bi-summary">
            <div class="summary-item"><span>Total Capa</span><strong id="total-capa">-</strong></div>
            <div class="summary-item" style="text-align: right;"><span>Current Loss</span><strong style="color:#ffcccb;" id="current-loss">-</strong></div>
        </div>
        <div id="list-container">
            </div>
    </div>

    <div id="map-container">
        <button id="sidebar-toggle">☰ List View</button>
        <div id="map"></div>
    </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // 1. 지도 초기화 (민자 스타일)
    const map = L.map('map', { zoomControl: false }).setView([30, 115], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '©OpenStreetMap, ©CartoDB'
    }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    // 2. 사이드바 토글 기능 (샘플 방식 적용)
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });

    // 전역 변수 설정
    let geoJsonLayer;
    let totalCapacity = 0;
    let currentLoss = 0;

    // 3. 데이터 로드 및 처리
    fetch('data.json')
        .then(response => response.json())
        .then(data => {
            totalCapacity = data.metadata.total_global_capacity;
            const listContainer = document.getElementById('list-container');

            geoJsonLayer = L.geoJSON(data, {
                // 마커 스타일링 (케파별 크기, 상태별 색상)
                pointToLayer: function (feature, latlng) {
                    const p = feature.properties;
                    const isTrouble = p.status !== 'Normal';
                    if (isTrouble) currentLoss += (p.loss || 0);

                    return L.circleMarker(latlng, {
                        radius: Math.sqrt(p.capacity) * 1.5, // 케파 비례 크기
                        fillColor: isTrouble ? '#222' : '#1597bb', // 트러블 시 검은색
                        color: "white",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                // 각 기능 연결 (팝업 및 리스트 생성)
                onEachFeature: function (feature, layer) {
                    const p = feature.properties;
                    
                    // 팝업 바인딩
                    const popupContent = `
                        <div class="popup-content">
                            <h3>${p.name}</h3>
                            <p><b>Location:</b> ${p.city}<br><span style="font-size:0.8rem">${p.address}</span></p>
                            <p><b>Capacity:</b> ${p.capacity}K MT / <b>Status:</b> <span style="color:${p.status!=='Normal'?'red':'green'}">${p.status}</span></p>
                             <p style="font-size:0.8rem; color:#666;">* Remarks: ${p.remarks}</p>
                        </div>
                    `;
                    layer.bindPopup(popupContent);

                    // 사이드바 리스트 아이템 생성
                    const item = document.createElement('div');
                    item.className = `plant-item ${p.status !== 'Normal' ? 'trouble' : ''}`;
                    item.innerHTML = `
                        <div class="plant-name">${p.name}</div>
                        <div class="plant-detail">
                            <span>${p.city} (${p.capacity}K)</span>
                             <span class="status-badge" style="background:${p.status!=='Normal'?'#222':'#1597bb'}; color:white;">${p.status}</span>
                        </div>
                    `;
                    
                    // 리스트 클릭 시 지도 인터랙션
                    item.addEventListener('click', () => {
                        map.flyTo(layer.getLatLng(), 9, { animate: true, duration: 1.5 });
                        layer.openPopup();
                        // 모바일 환경 등을 고려해 클릭 후 사이드바 닫기 (선택사항)
                        // sidebar.classList.remove('active'); 
                    });
                    listContainer.appendChild(item);
                }
            }).addTo(map);

            // BI 요약 정보 업데이트
            document.getElementById('total-capa').innerText = totalCapacity.toLocaleString() + "K";
            document.getElementById('current-loss').innerText = currentLoss.toLocaleString() + "K";
        });
</script>
</body>
</html>
